<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>لوحة تحكم الإعلانات والشراء</title>
  <meta name="color-scheme" content="dark light" />
  <style>
    :root{
      --bg:#0f1320; --card:#121a2a; --text:#f3f6ff; --muted:#9db0d1; --border:#21304c;
      --btn:#1a2744; --btn-hover:#22345a; --accent:#4ea2ff; --ok:#22c55e; --warn:#eab308;
      --log-bg:#0b1324; --log-border:#2a3d63;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;background:radial-gradient(1200px 600px at 20% -10%, #1a2440, transparent), var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
    .wrap{min-height:100svh;display:grid;place-items:center;padding:20px}
    .card{width:min(720px,100%);background:linear-gradient(180deg,var(--card),#0f182b);border:1px solid var(--border);border-radius:20px;box-shadow:0 20px 45px rgba(0,0,0,.35);padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:8px}
    h1{font-size:18px;margin:0}
    p.lead{margin:.25rem 0 1rem;color:var(--muted);font-size:14px}
    .badge{font-size:12px;padding:6px 10px;border-radius:999px;border:1px solid var(--border);background:#0d1a30;color:var(--muted);transition:background .25s ease,color .25s ease,border-color .25s ease}
    .badge.ok{border-color:rgba(34,197,94,.3);color:#c9ffd9;background:rgba(34,197,94,.08)}
    .badge.warn{border-color:rgba(234,179,8,.3);color:#fff0c2;background:rgba(234,179,8,.08)}
    .badge.error{border-color:rgba(239,68,68,.35);color:#ffe2e2;background:rgba(239,68,68,.08)}
    .section{border-top:1px dashed #223356;padding-top:14px;margin-top:12px}
    .section h2{font-size:14px;margin:0 0 10px;color:var(--muted)}
    .grid{display:grid;gap:10px;grid-template-columns:repeat(2,minmax(0,1fr))}
    button{appearance:none;border:1px solid var(--border);background:var(--btn);color:var(--text);border-radius:14px;padding:14px 16px;font-size:15px;cursor:pointer;transition:transform .08s ease, background .2s ease, border-color .2s ease}
    button:hover{background:var(--btn-hover);border-color:#2b4476}
    button:active{transform:translateY(1px)}
    .help{margin-top:10px;color:var(--muted);font-size:12px}
    .status-list{list-style:none;margin:10px 0 0;padding:0;display:flex;flex-direction:column;gap:6px}
    .status-pill{display:flex;justify-content:space-between;align-items:center;padding:10px 12px;border:1px dashed var(--log-border);border-radius:12px;background:rgba(19,28,45,.6);transition:background .2s ease, border-color .2s ease,color .2s ease}
    .status-pill.ready{border-color:rgba(34,197,94,.4);background:rgba(34,197,94,.08);color:#c9ffd9}
    .status-pill.loading{border-color:rgba(234,179,8,.4);background:rgba(234,179,8,.08);color:#fff0c2}
    .status-pill.blocked{border-color:rgba(239,68,68,.35);background:rgba(239,68,68,.08);color:#ffd6d6}
    .status-label{font-size:13px;font-weight:600;letter-spacing:.01em}
    .status-value{font-size:12px}
    .log{margin-top:12px;background:var(--log-bg);border:1px dashed var(--log-border);border-radius:12px;padding:10px;max-height:30svh;overflow:auto;white-space:pre-wrap;font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px}
    footer{display:flex;justify-content:space-between;align-items:center;color:var(--muted);font-size:12px;margin-top:12px}
    @media (max-width:520px){.grid{grid-template-columns:1fr}}
    @media (prefers-color-scheme:light){:root{--bg:#f6f8ff;--card:#ffffff;--text:#0c1222;--muted:#50607b;--border:#d9e2f2;--btn:#f0f4ff;--btn-hover:#e6eeff;--log-bg:#f8faff;--log-border:#c4d4f0}}
  </style>
</head>
<body>
  <main class="wrap">
    <section class="card" role="region" aria-label="لوحة التحكّم">
      <header>
        <h1>لوحة تحكّم الإعلانات والشراء</h1>
        <span id="status" class="badge warn" aria-live="polite">جارٍ البحث عن الجسر…</span>
      </header>
      <p class="lead">اضغط الزر المطلوب وسيقوم الجسر بتنفيذ النداء داخل التطبيق، أو اتركه يدير الإعلانات تلقائياً.</p>

      <div class="section" aria-labelledby="adsTitle">
        <h2 id="adsTitle">الإعلانات</h2>
        <div class="grid">
          <button onclick="requestShowAd('interstitial')">اعلن بيني (Interstitial)</button>
          <button onclick="requestShowAd('rewarded','level_end')">اعلن مكافأة (Rewarded)</button>
          <button onclick="requestShowAd('banner','bottom')">بانر أسفل (Banner)</button>
          <button onclick="requestShowAd('banner','top')">بانر أعلى (Banner)</button>
        </div>
        <p class="help">سيتم إرسال طلب <code>ShowAd</code> عبر <code>AndroidBridge.postMessage</code>، مع مراقبة جاهزية الإعلانات تلقائياً.</p>
        <ul class="status-list" id="adStatusList" aria-label="حالة توفر الإعلانات">
          <li class="status-pill blocked" data-ad-type="interstitial">
            <span class="status-label">إعلان بيني</span>
            <span class="status-value">بانتظار التحديث…</span>
          </li>
          <li class="status-pill blocked" data-ad-type="rewarded">
            <span class="status-label">إعلان مكافأة</span>
            <span class="status-value">بانتظار التحديث…</span>
          </li>
          <li class="status-pill blocked" data-ad-type="banner">
            <span class="status-label">بانر</span>
            <span class="status-value">بانتظار التحديث…</span>
          </li>
        </ul>
      </div>

      <div class="section" aria-labelledby="iapTitle">
        <h2 id="iapTitle">المشتريات داخل التطبيق</h2>
        <div class="grid">
          <button onclick="requestPurchase('coins_100')">شراء 100 كوين</button>
          <button onclick="requestPurchase('coins_500')">شراء 500 كوين</button>
          <button onclick="requestCheckProduct('coins_100')">فحص منتج coins_100</button>
          <button onclick="requestRestore()">استعادة المشتريات</button>
        </div>
      </div>

      <div class="section" aria-labelledby="initTitle">
        <h2 id="initTitle">التهيئة (Init)</h2>
        <div class="grid">
          <button onclick="requestInit('prod')">تهيئة بيئة الإنتاج</button>
          <button onclick="requestInit('staging')">تهيئة بيئة الاختبار</button>
        </div>
        <p class="help">يتم النداء تلقائياً عند التحميل، ويمكنك إعادة التهيئة يدوياً في أي وقت.</p>
      </div>

      <div id="log" class="log" aria-live="polite" aria-label="سجل الأحداث"></div>
      <footer>
        <span>© Bridge UI</span>
        <span>v2.0 – Web Bridge Spec</span>
      </footer>
    </section>
  </main>

  <script defer src="bridge.js"></script>
  <script>
    const statusEl = document.getElementById('status');
    const logEl = document.getElementById('log');
    const adStatusEls = new Map(Array.from(document.querySelectorAll('[data-ad-type]')).map((el) => [el.dataset.adType, el]));
    const adAvailability = new Map();
    const autoShowTargets = new Set();
    const autoShowInProgress = new Set();
    const AD_LABELS = {
      interstitial: 'إعلان بيني',
      rewarded: 'إعلان مكافأة',
      banner: 'بانر'
    };

    function appendLog(message, tone = 'info') {
      const time = new Date().toLocaleTimeString('ar', { hour12: false });
      const prefix = tone === 'error' ? '✗' : tone === 'warn' ? '⚠️' : '✓';
      logEl.textContent += `[${time}] ${prefix} ${message}\n`;
      logEl.scrollTop = logEl.scrollHeight;
    }

    function setStatus(text, tone = 'info') {
      statusEl.textContent = text;
      statusEl.classList.remove('ok', 'warn', 'error');
      if (tone === 'ok') {
        statusEl.classList.add('ok');
      } else if (tone === 'warn') {
        statusEl.classList.add('warn');
      } else if (tone === 'error') {
        statusEl.classList.add('error');
      }
    }

    function describeAvailability(state) {
      if (state.available) {
        return 'جاهز للعرض';
      }
      if (state.loading) {
        return 'جارٍ التحميل…';
      }
      switch ((state.state || '').toUpperCase()) {
        case 'DISABLED':
          return 'الإعلانات معطّلة';
        case 'MISSING_AD_UNIT':
          return 'معرّف الإعلان غير مضبوط';
        case 'LOAD_ERROR':
          return 'فشل التحميل، ستتم إعادة المحاولة';
        case 'NOT_INITIALIZED':
          return 'في انتظار التهيئة';
        case 'INITIALIZING':
          return 'جارٍ تهيئة الشبكة الإعلانية…';
        case 'CONSUMED':
          return 'تم العرض، جارٍ إعادة التحميل';
        case 'UNSUPPORTED':
          return 'غير مدعوم لهذا النوع';
        case 'NO_SERVICE':
          return 'مزود الإعلانات غير متوفر';
        case 'ON_DEMAND':
          return 'يتم تحميله عند الطلب';
        default:
          return 'غير متاح حالياً';
      }
    }

    function updateAdStatus(state) {
      if (!state || !state.adType) {
        return;
      }
      const key = state.adType.toLowerCase();
      const row = adStatusEls.get(key);
      if (!row) {
        return;
      }
      const valueEl = row.querySelector('.status-value');
      const labelEl = row.querySelector('.status-label');
      if (labelEl) {
        labelEl.textContent = AD_LABELS[key] || key;
      }
      row.classList.remove('ready', 'loading', 'blocked');
      row.classList.add(state.available ? 'ready' : state.loading ? 'loading' : 'blocked');
      if (valueEl) {
        valueEl.textContent = describeAvailability(state);
      }
    }

    function handleAvailabilityPayload(payload) {
      if (!payload || !payload.adType) {
        return null;
      }
      const normalized = payload.adType.toLowerCase();
      const snapshot = {
        adType: normalized,
        placementId: payload.placementId || null,
        available: Boolean(payload.available),
        loading: Boolean(payload.loading),
        state: payload.state || null
      };
      adAvailability.set(normalized, snapshot);
      updateAdStatus(snapshot);
      attemptAutoShow(normalized);
      return snapshot;
    }

    function attemptAutoShow(adType) {
      const normalized = (adType || '').toLowerCase();
      if (!normalized || !autoShowTargets.has(normalized) || autoShowInProgress.has(normalized)) {
        return;
      }
      const state = adAvailability.get(normalized);
      if (!state || !state.available || state.loading) {
        return;
      }

      autoShowInProgress.add(normalized);
      appendLog(`تشغيل ${AD_LABELS[normalized] || normalized} تلقائيًا بمجرد جاهزيته.`);
      requestShowAd(normalized)
        .then(() => {
          autoShowTargets.delete(normalized);
          autoShowInProgress.delete(normalized);
        })
        .catch((error) => {
          appendLog(`فشل العرض التلقائي: ${error.message}`, 'error');
          autoShowInProgress.delete(normalized);
          setTimeout(() => attemptAutoShow(normalized), 2500);
        });
    }

    function send(action, payload) {
      return WebBridge.sendRequest(action, payload)
        .then((result) => {
          appendLog(`${action} (${result.requestId}) → SUCCESS ${JSON.stringify(result.payload)}`);
          return result;
        })
        .catch((error) => {
          appendLog(`${action} (${error.requestId || '?'}) → ERROR ${error.code || 'UNKNOWN'} ${error.message}`, 'error');
          throw error;
        });
    }

    function requestInit(environment) {
      return send('Init', {
        environment,
        features: { ads: true, iap: true }
      });
    }

    function requestShowAd(adType, placementId) {
      const normalized = (adType || '').toLowerCase();
      if (normalized) {
        autoShowTargets.delete(normalized);
        autoShowInProgress.delete(normalized);
      }
      return send('ShowAd', {
        adType,
        placementId: placementId || undefined
      });
    }

    function requestPurchase(productId) {
      return send('Purchase', { productId });
    }

    function requestCheckProduct(productId) {
      return send('CheckProduct', { productId });
    }

    function requestRestore() {
      return send('RestorePurchases', {});
    }

    function checkAdAvailability(adType, placementId) {
      return send('CheckAdAvailability', {
        adType,
        placementId: placementId || undefined
      }).then((result) => handleAvailabilityPayload(result.payload) || result.payload || {});
    }

    function waitForBridge(timeoutMs = 8000) {
      if (WebBridge.isAvailable()) {
        return Promise.resolve();
      }

      return new Promise((resolve, reject) => {
        const start = Date.now();
        const unsubscribe = WebBridge.subscribe((event) => {
          if (event === 'bridge:available') {
            cleanup();
            resolve();
          }
        });

        const interval = setInterval(() => {
          if (WebBridge.isAvailable()) {
            cleanup();
            resolve();
          } else if (Date.now() - start > timeoutMs) {
            cleanup();
            reject(new Error('انتهى وقت الانتظار للجسر.'));
          }
        }, 400);

        function cleanup() {
          clearInterval(interval);
          unsubscribe();
        }
      });
    }

    function autoManageAd(adType) {
      const normalized = (adType || '').toLowerCase();
      if (!normalized || autoShowTargets.has(normalized)) {
        return;
      }
      autoShowTargets.add(normalized);
      attemptAutoShow(normalized);

      const poll = async () => {
        if (!autoShowTargets.has(normalized)) {
          return;
        }
        try {
          await checkAdAvailability(normalized);
        } catch (error) {
          appendLog(`تعذر التحقق من جاهزية ${AD_LABELS[normalized] || normalized}: ${error.message}`, 'error');
        }
        if (autoShowTargets.has(normalized)) {
          setTimeout(poll, 2500);
        }
      };
      poll();
    }

    async function bootstrap() {
      try {
        await waitForBridge();
      } catch (error) {
        setStatus('لم يتم العثور على الجسر. افتح التطبيق الأصلي.', 'warn');
        throw error;
      }

      setStatus('جارٍ تهيئة الإعلانات…', 'warn');

      try {
        await requestInit('staging');
        setStatus('تم الاتصال بالجسر وتهيئة الإعلانات.', 'ok');
      } catch (error) {
        setStatus('فشل تهيئة الإعلانات.', 'error');
        throw error;
      }

      autoManageAd('interstitial');
      checkAdAvailability('rewarded').catch(() => {});
      checkAdAvailability('banner').catch(() => {});
    }

    WebBridge.subscribe((event, detail) => {
      switch (event) {
        case 'bridge:unavailable':
          setStatus('الجسر غير مكتشف بعد.', 'warn');
          appendLog('الجسر متاح فقط داخل التطبيق.', 'warn');
          break;
        case 'bridge:available':
          setStatus('تم اكتشاف الجسر، جارٍ التهيئة…', 'warn');
          break;
        case 'request:sent':
          appendLog(`إرسال ${detail.action} (${detail.requestId})`, 'info');
          break;
        case 'event:adAvailability':
          handleAvailabilityPayload(detail);
          break;
        default:
          break;
      }
    });

    document.addEventListener('DOMContentLoaded', () => {
      appendLog('يتم التحقق من الجسر المضمن…');
      bootstrap().catch((error) => {
        appendLog(`فشل الإعداد التلقائي: ${error.message}`, 'error');
      });
    });

    window.requestInit = requestInit;
    window.requestShowAd = requestShowAd;
    window.requestPurchase = requestPurchase;
    window.requestCheckProduct = requestCheckProduct;
    window.requestRestore = requestRestore;
  </script>

  <noscript><div style="padding:12px;text-align:center;color:#b00">⚠️ هذه الصفحة تتطلب JavaScript.</div></noscript>
</body>
</html>
